# =========================================================================
#  FRONTEND DEPLOYMENT (REACT - Production Grade)
# Static React assets served by Nginx or similar.
# =========================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend-deployment
  labels:
    app: frontend
    environment: production
spec:
  replicas: 1 # High availability
  selector:
    matchLabels:
      app: frontend
  strategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: frontend
        version: v1.0.0 # Istio readiness label
    spec:
      terminationGracePeriodSeconds: 30
      containers:
        - name: frontend-container
          image: 17rj/frontend-restaurant-mern:latest # Use specific tags
          ports:
            - containerPort: 80

          # Resource Management for Frontend/Webserver
          resources:
            requests:
              cpu: "50m"
              memory: "128Mi"
            limits:
              cpu: "300m"
              memory: "512Mi"

          env:
            # VITE_API_URL from ConfigMap, pointing to internal backend service
            - name: VITE_API_URL
              valueFrom:
                configMapKeyRef:
                  name: mern-app-config
                  key: frontend-api-url

          startupProbe:
            httpGet:
              path: /
              port: 80
            initialDelaySeconds: 10 # Wait 10s before first check
            periodSeconds: 5 # Check every 5s
            timeoutSeconds: 3
            failureThreshold: 20 # Allow 20 failures = 100s total startup time
            successThreshold: 1

          # Health Probes for the Webserver
          livenessProbe:
            httpGet:
              path: /
              port: 80
            initialDelaySeconds: 0
            periodSeconds: 10
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /
              port: 80
            initialDelaySeconds: 5
            periodSeconds: 5
            failureThreshold: 2

---
#  FRONTEND SERVICE (LoadBalancer/External Access)
# Exposes the application publicly.
apiVersion: v1
kind: Service
metadata:
  name: frontend-service
  labels:
    app: frontend
spec:
  selector:
    app: frontend
  ports:
    - protocol: TCP
      port: 80
      targetPort: 3000
  type: LoadBalancer # Exposes the service externally
